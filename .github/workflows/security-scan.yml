name: Security Scan

on: [push, pull_request]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Dependency Check Database
        uses: actions/cache@v3
        with:
          path: ~/.dependency-check/data
          key: dependency-check-db-${{ runner.os }}-${{ hashFiles('**/composer.lock', '**/package-lock.json') }}
          restore-keys: |
            dependency-check-db-${{ runner.os }}-

      - name: Download and Install OWASP Dependency Check
        run: |
          echo "üì¶ Downloading OWASP Dependency Check..."
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.0/dependency-check-10.0.0-release.zip
          unzip -q dependency-check-10.0.0-release.zip -d dependency-check
          chmod +x dependency-check/dependency-check/bin/dependency-check.sh
          
          echo "‚úÖ Dependency Check installed"
          ./dependency-check/dependency-check/bin/dependency-check.sh --version

      - name: Run Dependency Check Scan
        run: |
          echo "üîç Starting Dependency Check scan..."
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          mkdir -p reports
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å JSON —Ñ–∏–¥–∞–º–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ API –∫–ª—é—á–∞)
          ./dependency-check/dependency-check/bin/dependency-check.sh \
            --project "DVWA Security Scan" \
            --scan ./app \
            --format HTML \
            --format JSON \
            --out ./reports \
            --disableNodeAudit \
            --disableNodeJS \
            --disableRetireJS \
            --disableOssIndex \
            --nvdApiDelay 2000 \
            --nvdMaxRetryCount 10 \
            --connectionTimeout 300000 \
            --proxyserver "" \
            --failOnCVSS 0
          
          echo "‚úÖ Scan completed!"

      - name: Check Generated Reports
        run: |
          echo "üìä Checking generated reports..."
          if [ -f "reports/dependency-check-report.html" ]; then
            echo "‚úÖ HTML report generated: $(ls -lh reports/dependency-check-report.html)"
            echo "Report preview:"
            grep -E "(<title>|vulnerabilities found|Vulnerabilities)" reports/dependency-check-report.html | head -5
          else
            echo "‚ùå HTML report not found"
          fi
          
          if [ -f "reports/dependency-check-report.json" ]; then
            echo "‚úÖ JSON report generated: $(ls -lh reports/dependency-check-report.json)"
            echo "JSON summary:"
            python3 -c "import json; data = json.load(open('reports/dependency-check-report.json')); print(f'Dependencies: {len(data[\"dependencies\"])}, Vulnerabilities: {sum(len(d.get(\"vulnerabilities\", [])) for d in data[\"dependencies\"])}')"
          else
            echo "‚ùå JSON report not found"
          fi

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            reports/
          retention-days: 30
          if-no-files-found: warn

  security-checks:
    runs-on: ubuntu-latest
    needs: [sonarqube, dependency-check]
    steps:
      - name: Security Scan Summary
        run: |
          echo "‚úÖ All security scans completed successfully!"
          echo "SAST (SonarQube) and SCA (Dependency Check) reports are available as artifacts."