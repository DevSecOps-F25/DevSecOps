name: Security Scan

on: [push, pull_request]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Dependency Check Database
        uses: actions/cache@v3
        with:
          path: ~/.dependency-check/data
          key: dependency-check-db-${{ runner.os }}-v4
          restore-keys: |
            dependency-check-db-${{ runner.os }}-

      - name: Configure Dependency Check (JSON Feeds Only)
        run: |
          echo "âš™ï¸ Configuring Dependency Check to use JSON feeds only (NO API)"
          mkdir -p ~/.dependency-check
          # ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ NVD API, Ğ·Ğ°ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ JSON feeds
          echo "data.nvd.validForHours=0" > ~/.dependency-check/dependency-check.properties
          echo "âœ… Configuration: JSON feeds only, no API"

      - name: Run Dependency Check (SCA)
        continue-on-error: true
        timeout-minutes: 90
        run: |
          echo "ğŸ” Starting Dependency Check scan..."
          echo "Using JSON feeds only (NO NVD API)"
          
          mkdir -p reports
          mkdir -p ~/.dependency-check/data
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
          DB_FILES=$(find ~/.dependency-check/data -type f 2>/dev/null | wc -l)
          
          if [ "$DB_FILES" -gt 50 ]; then
            echo "âœ… Using cached database ($DB_FILES files)"
            USE_NOUPDATE="--noupdate"
          else
            echo "âš ï¸ No cached database found ($DB_FILES files)"
            echo "Will update database using JSON feeds (NO API) - this may take 30-60 minutes"
            USE_NOUPDATE=""
          fi
          
          # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Docker Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸ĞµĞ¹
          # Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ volume Ğ´Ğ»Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ¾Ğº
          # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ --data Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ¿ÑƒÑ‚Ğ¸ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
          docker run --rm \
            -v "$PWD:/src" \
            -v "$PWD/reports:/report" \
            -v "$HOME/.dependency-check/data:/data" \
            -v "$HOME/.dependency-check/dependency-check.properties:/usr/share/dependency-check/conf/dependency-check.properties:ro" \
            owasp/dependency-check:latest \
            --scan /src/app \
            --format HTML \
            --format JSON \
            --out /report \
            --project "DVWA" \
            --data /data \
            $USE_NOUPDATE \
            --enableExperimental \
            --failOnCVSS 11 || {
              echo "âš ï¸ Scan completed with warnings"
            }
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ğ»Ğ°ÑÑŒ Ğ»Ğ¸ Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
          NEW_DB_FILES=$(find ~/.dependency-check/data -type f 2>/dev/null | wc -l)
          if [ "$NEW_DB_FILES" -gt 50 ]; then
            echo "âœ… Database is available ($NEW_DB_FILES files) - will be cached for next run"
          fi
          
          echo "âœ… Scan completed!"

      - name: Check Generated Reports
        run: |
          echo "ğŸ“Š Checking generated reports..."
          if [ -f "reports/dependency-check-report.html" ]; then
            echo "âœ… HTML report generated: $(ls -lh reports/dependency-check-report.html)"
          else
            echo "âŒ HTML report not found"
          fi
          
          if [ -f "reports/dependency-check-report.json" ]; then
            echo "âœ… JSON report generated: $(ls -lh reports/dependency-check-report.json)"
            python3 -c "import json, os; data = json.load(open('reports/dependency-check-report.json')) if os.path.exists('reports/dependency-check-report.json') else {}; deps = len(data.get('dependencies', [])); vulns = sum(len(d.get('vulnerabilities', [])) for d in data.get('dependencies', [])); print(f'Scanned Dependencies: {deps}'); print(f'Total Vulnerabilities Found: {vulns}')"
          else
            echo "âŒ JSON report not found"
          fi

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
          retention-days: 30
          if-no-files-found: warn

  security-checks:
    runs-on: ubuntu-latest
    needs: [sonarqube, dependency-check]
    steps:
      - name: Security Scan Summary
        run: |
          echo "========================================"
          echo "âœ… All security scans completed successfully!"
          echo "ğŸ“ Available reports:"
          echo "   - SonarQube (SAST) results: Check SonarCloud dashboard"
          echo "   - Dependency Check (SCA) reports: Download 'security-reports' artifact"
          echo "========================================"
