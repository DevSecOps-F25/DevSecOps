name: Security Scan

on: [push, pull_request]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Dependency Check (SCA) with Docker
        continue-on-error: true
        timeout-minutes: 60
        run: |
          echo "üîç Starting Dependency Check scan using Docker..."
          
          mkdir -p reports
          mkdir -p ~/.dependency-check/data
          
          # –ö—ç—à–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
          DB_FILES=$(find ~/.dependency-check/data -type f 2>/dev/null | wc -l)
          
          if [ "$DB_FILES" -gt 50 ]; then
            echo "‚úÖ Using cached database ($DB_FILES files)"
            echo "Running scan with --noupdate"
            docker run --rm \
              -v "$PWD:/src" \
              -v "$PWD/reports:/report" \
              -v "$HOME/.dependency-check/data:/usr/share/dependency-check/data" \
              owasp/dependency-check:latest \
              --scan /src/app \
              --format HTML \
              --format JSON \
              --out /report \
              --project "DVWA" \
              --noupdate \
              --enableExperimental \
              --failOnCVSS 11 || {
                echo "‚ö†Ô∏è Scan completed with warnings"
              }
          else
            echo "‚ö†Ô∏è No cached database found ($DB_FILES files)"
            echo "Updating database first (this will take 30-60 minutes)..."
            echo "Using JSON feeds (no API key needed)"
            
            # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            docker run --rm \
              -v "$HOME/.dependency-check/data:/usr/share/dependency-check/data" \
              owasp/dependency-check:latest \
              --updateonly || {
                echo "‚ö†Ô∏è Database update had errors, but will continue"
              }
            
            # –ó–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            echo "Running scan with updated database..."
            docker run --rm \
              -v "$PWD:/src" \
              -v "$PWD/reports:/report" \
              -v "$HOME/.dependency-check/data:/usr/share/dependency-check/data" \
              owasp/dependency-check:latest \
              --scan /src/app \
              --format HTML \
              --format JSON \
              --out /report \
              --project "DVWA" \
              --noupdate \
              --enableExperimental \
              --failOnCVSS 11 || {
                echo "‚ö†Ô∏è Scan completed with warnings"
              }
          fi
          
          echo "‚úÖ Scan completed!"

      - name: Check Generated Reports
        run: |
          echo "üìä Checking generated reports..."
          if [ -f "reports/dependency-check-report.html" ]; then
            echo "‚úÖ HTML report generated: $(ls -lh reports/dependency-check-report.html)"
          else
            echo "‚ùå HTML report not found"
          fi
          
          if [ -f "reports/dependency-check-report.json" ]; then
            echo "‚úÖ JSON report generated: $(ls -lh reports/dependency-check-report.json)"
            python3 -c "import json, os; data = json.load(open('reports/dependency-check-report.json')) if os.path.exists('reports/dependency-check-report.json') else {}; deps = len(data.get('dependencies', [])); vulns = sum(len(d.get('vulnerabilities', [])) for d in data.get('dependencies', [])); print(f'Scanned Dependencies: {deps}'); print(f'Total Vulnerabilities Found: {vulns}')"
          else
            echo "‚ùå JSON report not found"
          fi

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
          retention-days: 30
          if-no-files-found: warn

  security-checks:
    runs-on: ubuntu-latest
    needs: [sonarqube, dependency-check]
    steps:
      - name: Security Scan Summary
        run: |
          echo "========================================"
          echo "‚úÖ All security scans completed successfully!"
          echo "üìÅ Available reports:"
          echo "   - SonarQube (SAST) results: Check SonarCloud dashboard"
          echo "   - Dependency Check (SCA) reports: Download 'security-reports' artifact"
          echo "========================================"
